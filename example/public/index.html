<style>
  body {
    margin:0px;
    background: grey;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<!doctype html>
<div id='app'>
<div>
  <div style='position:relative'>
    <div>
      <canvas ref="canvas" style="position:absolute; left:5px;top:5px; max-width: calc(100vw - 400px);max-height: calc(100vh - 10px);outline: 1px solid white;"></canvas>
      <canvas ref="detcanvas" style="position:absolute; left:5px;top:5px; width: calc(100vw - 400px);max-height: calc(100vh - 10px);;"></canvas>
    </div>

    <div style='float:right;margin-right:20px;margin-top:5px;'>
        <button @click="calc" v-show="!detecting">calc</button>
        <div v-if="detect" style='margin-left:10px'>
          <div style='border:1px solid black;background: white'>
            <p>类别：{{detect.clzName}}</p>
            <p>计算耗时：{{detect.objClassCostTime}} ms</p>
            <p>计算平台：{{detect.objClassDeployTarget}}</p>
            <p>置信度：{{detect.score}}</p>
          </div>
          <div style='border:1px solid black;background: white'>
              <p>对像数：{{detect.detectionResult.length}}</p>
              <p>计算耗时：{{detect.objDetectCostTime}} ms</p>
              <p>计算平台：{{detect.objDetectDeployTarget}}</p>
          </div>
          <button @click="stopCanvas" >Toogle Canvas Render</button>
        </div>
      </div>
  </div>
</div>
</div>

<script>

var app = new Vue({
  el: '#app',
  data() {
    return {
      ws : null,
      canvas: null,
      detcanvas: null,
      g: null,
      dg: null,
      axios: null,
      detect: null,
      detecting: false,
      isstopCanvas: false,
      img: new Image(),
    }
  },
  mounted () {
    this.ws = new WebSocket('ws://localhost:9002', 'minicap')
    this.ws.binaryType = 'blob'
    this.ws.onmessage = this.onmessage
    this.ws.onopen = () => {
      this.canvas = this.$refs.canvas;
      this.detcanvas = this.$refs.detcanvas;
      this.g = this.canvas.getContext('2d');
      this.dg = this.detcanvas.getContext('2d');
    }
    this.img.onload = () => {
      this.canvas.width = this.img.width
      this.canvas.height = this.img.height
      this.detcanvas.width = this.img.width
      this.detcanvas.height = this.img.height
      this.g.drawImage(this.img,0,0);
      this.detectDetect();
    }
    this.axios = axios.create({
      baseURL: ' http://10.34.163.245:28180/api/sample/test/'
    });
  },
  methods: {
    stopCanvas () {
      this.isstopCanvas = !this.isstopCanvas
    },
    async $sleep(ms) {
      let timeout = () => {
        return new Promise(resolve => setTimeout(resolve, ms))
      }
      await timeout(ms)
    },
    async toBlob() {
      return new Promise(resolve => {
        this.canvas.toBlob(async (blob) => resolve(blob), "image/jpeg", 1)
      })
    },
    async calc() {
      while(true) {
        this.detecting = true
        let blob = await this.toBlob()
        let fd = new FormData()
        fd.append('file', blob)
        this.detect = (await this.axios.post('/20/19',fd)).data;
        await this.$sleep(100);
      }
      this.detecting = false
    },
    async detectDetect() {
      if(this.detect){
          this.dg.strokeStyle="red";
          this.dg.lineWidth="6";
          this.dg.font="bold 20px sans-serif";
          this.dg.fillStyle = "red";
          for( let d of this.detect.detectionResult ){
            this.dg.strokeRect(d.x, d.y, d.width, d.height);
            this.dg.fillText(d.name, d.x,d.y - 15);
          }
      }
    },
    onmessage (message) {

      if( this.isstopCanvas ) {
        this.g.drawImage(this.img,0,0);
        this.detectDetect();
      } else {
        var blob = new Blob([message.data], {type: 'image/jpeg'})
        var URL = window.URL || window.webkitURL
        if(this.img.src){
          URL.revokeObjectURL(this.img.src);
        }
        this.img.src = URL.createObjectURL(blob);
      }
    }
  }
});

</script>
